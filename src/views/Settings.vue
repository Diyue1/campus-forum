<template>
  <div class="settings-container cyber-page-container">
    <CyberDecor />
    <div class="cyber-content">
      <!-- è®¾ç½®å¤´éƒ¨ -->
      <div class="settings-header">
        <h1 class="settings-title cyber-title">
          è®¾ç½®
        </h1>
        <p class="settings-subtitle">
          ç®¡ç†æ‚¨çš„è´¦æˆ·å’Œåå¥½è®¾ç½®
        </p>
      </div>

      <!-- è®¾ç½®å†…å®¹ -->
      <div class="settings-content">
        <!-- è´¦æˆ·è®¾ç½® -->
        <n-card class="settings-section cyber-card">
          <template #header>
            <div class="section-header">
              <span class="section-icon">ğŸ‘¤</span>
              <span class="section-title">è´¦æˆ·è®¾ç½®</span>
            </div>
          </template>
        
          <n-space
            vertical
            size="large"
          >
            <!-- ä¸ªäººä¿¡æ¯ -->
            <div class="setting-item">
              <div class="setting-info">
                <h3 class="setting-label">
                  ä¸ªäººä¿¡æ¯
                </h3>
                <p class="setting-desc">
                  ç®¡ç†æ‚¨çš„ä¸ªäººèµ„æ–™ä¿¡æ¯
                </p>
              </div>
              <n-button
                class="setting-action"
                @click="editProfile"
              >
                ç¼–è¾‘èµ„æ–™
              </n-button>
            </div>

            <!-- å¯†ç å®‰å…¨ -->
            <div class="setting-item">
              <div class="setting-info">
                <h3 class="setting-label">
                  å¯†ç å®‰å…¨
                </h3>
                <p class="setting-desc">
                  ä¿®æ”¹æ‚¨çš„ç™»å½•å¯†ç 
                </p>
              </div>
              <n-button
                class="setting-action"
                @click="changePassword"
              >
                ä¿®æ”¹å¯†ç 
              </n-button>
            </div>

            <!-- éšç§è®¾ç½® -->
            <div class="setting-item">
              <div class="setting-info">
                <h3 class="setting-label">
                  éšç§è®¾ç½®
                </h3>
                <p class="setting-desc">
                  æ§åˆ¶æ‚¨çš„éšç§å’Œå¯è§æ€§
                </p>
              </div>
              <n-button
                class="setting-action"
                @click="privacySettings"
              >
                éšç§è®¾ç½®
              </n-button>
            </div>
          </n-space>
        </n-card>

        <!-- é€šçŸ¥è®¾ç½® -->
        <n-card class="settings-section">
          <template #header>
            <div class="section-header">
              <span class="section-icon">ğŸ””</span>
              <span class="section-title">é€šçŸ¥è®¾ç½®</span>
            </div>
          </template>
        
          <n-space
            vertical
            size="large"
          >
            <!-- æ¶ˆæ¯é€šçŸ¥ -->
            <div class="setting-item">
              <div class="setting-info">
                <h3 class="setting-label">
                  æ¶ˆæ¯é€šçŸ¥
                </h3>
                <p class="setting-desc">
                  æ¥æ”¶ç§ä¿¡å’Œè¯„è®ºé€šçŸ¥
                </p>
              </div>
              <n-switch v-model:value="notificationSettings.messages" />
            </div>

            <!-- ç‚¹èµé€šçŸ¥ -->
            <div class="setting-item">
              <div class="setting-info">
                <h3 class="setting-label">
                  ç‚¹èµé€šçŸ¥
                </h3>
                <p class="setting-desc">
                  æ¥æ”¶ç‚¹èµå’Œæ”¶è—é€šçŸ¥
                </p>
              </div>
              <n-switch v-model:value="notificationSettings.likes" />
            </div>

            <!-- å…³æ³¨é€šçŸ¥ -->
            <div class="setting-item">
              <div class="setting-info">
                <h3 class="setting-label">
                  å…³æ³¨é€šçŸ¥
                </h3>
                <p class="setting-desc">
                  æ¥æ”¶æ–°å…³æ³¨è€…é€šçŸ¥
                </p>
              </div>
              <n-switch v-model:value="notificationSettings.follows" />
            </div>

            <!-- ç³»ç»Ÿé€šçŸ¥ -->
            <div class="setting-item">
              <div class="setting-info">
                <h3 class="setting-label">
                  ç³»ç»Ÿé€šçŸ¥
                </h3>
                <p class="setting-desc">
                  æ¥æ”¶ç³»ç»Ÿé‡è¦é€šçŸ¥
                </p>
              </div>
              <n-switch v-model:value="notificationSettings.system" />
            </div>
          </n-space>
        </n-card>

        <!-- æ˜¾ç¤ºè®¾ç½® -->
        <n-card class="settings-section">
          <template #header>
            <div class="section-header">
              <span class="section-icon">ğŸ¨</span>
              <span class="section-title">æ˜¾ç¤ºè®¾ç½®</span>
            </div>
          </template>
        
          <n-space
            vertical
            size="large"
          >
            <!-- ä¸»é¢˜æ¨¡å¼ -->
            <div class="setting-item">
              <div class="setting-info">
                <h3 class="setting-label">
                  ä¸»é¢˜æ¨¡å¼
                </h3>
                <p class="setting-desc">
                  é€‰æ‹©æ‚¨å–œæ¬¢çš„ä¸»é¢˜æ¨¡å¼
                </p>
              </div>
              <n-select
                v-model:value="displaySettings.theme"
                :options="themeOptions"
                style="width: 120px"
              />
            </div>

            <!-- è¯­è¨€è®¾ç½® -->
            <div class="setting-item">
              <div class="setting-info">
                <h3 class="setting-label">
                  è¯­è¨€è®¾ç½®
                </h3>
                <p class="setting-desc">
                  é€‰æ‹©ç•Œé¢æ˜¾ç¤ºè¯­è¨€
                </p>
              </div>
              <n-select
                v-model:value="displaySettings.language"
                :options="languageOptions"
                style="width: 120px"
              />
            </div>

            <!-- å­—ä½“å¤§å° -->
            <div class="setting-item">
              <div class="setting-info">
                <h3 class="setting-label">
                  å­—ä½“å¤§å°
                </h3>
                <p class="setting-desc">
                  è°ƒæ•´ç•Œé¢å­—ä½“å¤§å°
                </p>
              </div>
              <n-select
                v-model:value="displaySettings.fontSize"
                :options="fontSizeOptions"
                style="width: 120px"
              />
            </div>
          </n-space>
        </n-card>

        <!-- æ•°æ®ç®¡ç† -->
        <n-card class="settings-section">
          <template #header>
            <div class="section-header">
              <span class="section-icon">ğŸ’¾</span>
              <span class="section-title">æ•°æ®ç®¡ç†</span>
            </div>
          </template>
        
          <n-space
            vertical
            size="large"
          >
            <!-- å¯¼å‡ºæ•°æ® -->
            <div class="setting-item">
              <div class="setting-info">
                <h3 class="setting-label">
                  å¯¼å‡ºæ•°æ®
                </h3>
                <p class="setting-desc">
                  å¯¼å‡ºæ‚¨çš„å¸–å­å’Œæ•°æ®
                </p>
              </div>
              <n-button
                class="setting-action"
                @click="exportData"
              >
                å¯¼å‡ºæ•°æ®
              </n-button>
            </div>

            <!-- æ¸…é™¤ç¼“å­˜ -->
            <div class="setting-item">
              <div class="setting-info">
                <h3 class="setting-label">
                  æ¸…é™¤ç¼“å­˜
                </h3>
                <p class="setting-desc">
                  æ¸…é™¤æœ¬åœ°ç¼“å­˜æ•°æ®
                </p>
              </div>
              <n-button
                class="setting-action"
                @click="clearCache"
              >
                æ¸…é™¤ç¼“å­˜
              </n-button>
            </div>

            <!-- åˆ é™¤è´¦æˆ· -->
            <div class="setting-item danger">
              <div class="setting-info">
                <h3 class="setting-label">
                  åˆ é™¤è´¦æˆ·
                </h3>
                <p class="setting-desc">
                  æ°¸ä¹…åˆ é™¤æ‚¨çš„è´¦æˆ·å’Œæ‰€æœ‰æ•°æ®
                </p>
              </div>
              <n-button
                type="error"
                class="setting-action"
                @click="deleteAccount"
              >
                åˆ é™¤è´¦æˆ·
              </n-button>
            </div>
          </n-space>
        </n-card>
      </div>

      <!-- ç¼–è¾‘èµ„æ–™æ¨¡æ€æ¡† -->
      <n-modal
        v-model:show="showEditProfile"
        preset="card"
        title="ç¼–è¾‘ä¸ªäººèµ„æ–™"
        size="huge"
      >
        <EditProfileForm @close="showEditProfile = false" />
      </n-modal>

      <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
      <n-modal
        v-model:show="showChangePassword"
        preset="card"
        title="ä¿®æ”¹å¯†ç "
        size="medium"
      >
        <div class="password-form">
          <n-form
            ref="passwordFormRef"
            :model="passwordForm"
            :rules="passwordRules"
          >
            <n-form-item
              label="å½“å‰å¯†ç "
              path="currentPassword"
            >
              <n-input
                v-model:value="passwordForm.currentPassword"
                type="password"
                placeholder="è¯·è¾“å…¥å½“å‰å¯†ç "
              />
            </n-form-item>
            <n-form-item
              label="æ–°å¯†ç "
              path="newPassword"
            >
              <n-input
                v-model:value="passwordForm.newPassword"
                type="password"
                placeholder="è¯·è¾“å…¥æ–°å¯†ç "
              />
            </n-form-item>
            <n-form-item
              label="ç¡®è®¤å¯†ç "
              path="confirmPassword"
            >
              <n-input
                v-model:value="passwordForm.confirmPassword"
                type="password"
                placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
              />
            </n-form-item>
          </n-form>
          <div class="form-actions">
            <n-button @click="showChangePassword = false">
              å–æ¶ˆ
            </n-button>
            <n-button
              type="primary"
              @click="submitPasswordChange"
            >
              ç¡®è®¤ä¿®æ”¹
            </n-button>
          </div>
        </div>
      </n-modal>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import CyberDecor from '@/components/CyberDecor.vue'
import { useUserStore } from '@/stores/user'
import { db } from '@/utils/database'
import EditProfileForm from '@/components/EditProfileForm.vue'

const message = useMessage()
const userStore = useUserStore()

// æ¨¡æ€æ¡†çŠ¶æ€
const showEditProfile = ref(false)
const showChangePassword = ref(false)

// é€šçŸ¥è®¾ç½®
const notificationSettings = reactive({
  messages: true,
  likes: true,
  follows: true,
  system: true
})

// æ˜¾ç¤ºè®¾ç½®
const displaySettings = reactive({
  theme: 'dark',
  language: 'zh-CN',
  fontSize: 'medium'
})

// å¯†ç è¡¨å•
const passwordForm = reactive({
  currentPassword: '',
  newPassword: '',
  confirmPassword: ''
})

const passwordRules = {
  currentPassword: [
    { required: true, message: 'è¯·è¾“å…¥å½“å‰å¯†ç ', trigger: 'blur' }
  ],
  newPassword: [
    { required: true, message: 'è¯·è¾“å…¥æ–°å¯†ç ', trigger: 'blur' },
    { min: 6, message: 'å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½', trigger: 'blur' }
  ],
  confirmPassword: [
    { required: true, message: 'è¯·ç¡®è®¤æ–°å¯†ç ', trigger: 'blur' },
    {
      validator: (rule: any, value: string) => {
        return value === passwordForm.newPassword
      },
      message: 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´',
      trigger: 'blur'
    }
  ]
}

// é€‰é¡¹æ•°æ®
const themeOptions = [
  { label: 'æ·±è‰²æ¨¡å¼', value: 'dark' },
  { label: 'æµ…è‰²æ¨¡å¼', value: 'light' },
  { label: 'è‡ªåŠ¨', value: 'auto' }
]

const languageOptions = [
  { label: 'ç®€ä½“ä¸­æ–‡', value: 'zh-CN' },
  { label: 'English', value: 'en-US' }
]

const fontSizeOptions = [
  { label: 'å°', value: 'small' },
  { label: 'ä¸­', value: 'medium' },
  { label: 'å¤§', value: 'large' }
]

// æ–¹æ³•
const editProfile = () => {
  showEditProfile.value = true
}

const changePassword = () => {
  showChangePassword.value = true
}

const privacySettings = () => {
  message.info('éšç§è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­')
}

const submitPasswordChange = () => {
  if (passwordForm.newPassword !== passwordForm.confirmPassword) {
    message.error('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´')
    return
  }
  
  // è¿™é‡Œåº”è¯¥è°ƒç”¨APIä¿®æ”¹å¯†ç 
  message.success('å¯†ç ä¿®æ”¹æˆåŠŸ')
  showChangePassword.value = false
  
  // é‡ç½®è¡¨å•
  Object.assign(passwordForm, {
    currentPassword: '',
    newPassword: '',
    confirmPassword: ''
  })
}

const exportData = () => {
  const user = userStore.currentUser
  if (!user) return
  
  const userPosts = db.getPosts().filter(post => post.authorId === user.id)
  const userComments = db.getComments().filter(comment => comment.authorId === user.id)
  
  const exportData = {
    user: {
      id: user.id,
      username: user.username,
      nickname: user.nickname,
      email: user.email,
      bio: user.bio,
      joinDate: user.joinDate
    },
    posts: userPosts,
    comments: userComments,
    exportDate: new Date().toISOString()
  }
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `campus-forum-data-${user.username}-${new Date().toISOString().split('T')[0]}.json`
  a.click()
  URL.revokeObjectURL(url)
  
  message.success('æ•°æ®å¯¼å‡ºæˆåŠŸ')
}

const clearCache = () => {
  // æ¸…é™¤localStorageä¸­çš„ç¼“å­˜æ•°æ®
  const keysToKeep = ['campus_forum_users', 'campus_forum_posts', 'campus_forum_comments', 'campus_forum_messages']
  const allKeys = Object.keys(localStorage)
  
  allKeys.forEach(key => {
    if (!keysToKeep.includes(key)) {
      localStorage.removeItem(key)
    }
  })
  
  message.success('ç¼“å­˜æ¸…é™¤æˆåŠŸ')
}

const deleteAccount = () => {
  // è¿™é‡Œåº”è¯¥æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  message.warning('åˆ é™¤è´¦æˆ·åŠŸèƒ½éœ€è¦è¿›ä¸€æ­¥ç¡®è®¤')
}

onMounted(() => {
  // åŠ è½½ç”¨æˆ·è®¾ç½®
  const settings = localStorage.getItem('user_settings')
  if (settings) {
    const parsedSettings = JSON.parse(settings)
    Object.assign(notificationSettings, parsedSettings.notifications || {})
    Object.assign(displaySettings, parsedSettings.display || {})
  }
})
</script>

<style scoped>
.settings-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  background: var(--interknot-gradient-bg);
  min-height: 100vh;
}

.settings-header {
  text-align: center;
  margin-bottom: 32px;
}

.settings-title {
  font-size: 32px;
  font-weight: 700;
  background: var(--interknot-gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin: 0 0 8px 0;
}

.settings-subtitle {
  font-size: 16px;
  color: var(--interknot-text-secondary);
  margin: 0;
}

.settings-content {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.settings-section {
  background: var(--interknot-bg-card);
  border: 1px solid var(--interknot-border-primary);
  border-radius: var(--interknot-radius-lg);
  backdrop-filter: blur(20px);
}

.section-header {
  display: flex;
  align-items: center;
  gap: 12px;
}

.section-icon {
  font-size: 20px;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--interknot-text-primary);
}

.setting-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 0;
  border-bottom: 1px solid var(--interknot-border-secondary);
}

.setting-item:last-child {
  border-bottom: none;
}

.setting-item.danger {
  border-color: rgba(244, 67, 54, 0.2);
}

.setting-info {
  flex: 1;
}

.setting-label {
  font-size: 16px;
  font-weight: 600;
  color: var(--interknot-text-primary);
  margin: 0 0 4px 0;
}

.setting-desc {
  font-size: 14px;
  color: var(--interknot-text-secondary);
  margin: 0;
}

.setting-action {
  background: var(--interknot-gradient-primary);
  border: none;
  color: white;
  font-weight: 600;
  border-radius: var(--interknot-radius-md);
  padding: 8px 16px;
  transition: all var(--interknot-transition-fast);
}

.setting-action:hover {
  transform: translateY(-1px);
  box-shadow: var(--interknot-shadow-md);
}

.password-form {
  padding: 20px 0;
}

.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 24px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .settings-container {
    padding: 16px;
  }
  
  .settings-title {
    font-size: 24px;
  }
  
  .settings-subtitle {
    font-size: 14px;
  }
  
  .setting-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .setting-action {
    width: 100%;
  }
}
</style>
